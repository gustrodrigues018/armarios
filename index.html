<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Armários</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 20px;
    }
    form {
      max-width: 600px;
      margin-bottom: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    }
    form input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      transition: border-color 0.3s;
    }
    form input:focus {
      border-color: #007bff;
      outline: none;
    }
    form button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      width: 100%;
      max-width: 100%;
      transition: background 0.3s;
    }
    form button:hover {
      background-color: #0056b3;
    }

    #btnExportarDocx {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      width: 280px;
      max-width: 90%;
      transition: background 0.3s;
      margin: 0 auto 30px auto;
      display: block;
    }
    #btnExportarDocx:hover {
      background-color: #1e7e34;
    }

    #pesquisa {
      max-width: 600px;
      width: 100%;
      padding: 12px 16px;
      font-size: 18px;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 800px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
      margin-bottom: 60px;
    }
    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .btn-editar {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-editar:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

  <form id="form">
    <input id="nome" type="text" placeholder="Nome" required />
    <input id="empresa" type="text" placeholder="Empresa" />
    <input id="setor" type="text" placeholder="Setor" />
    <input id="numero" type="number" placeholder="Número" required />
    <button type="submit">Adicionar / Atualizar</button>
  </form>


  <input id="pesquisa" type="text" placeholder="Pesquisar..." />

  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Empresa</th>
        <th>Setor</th>
        <th>Número</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tabela-body">
      <tr><td colspan="5">Carregando dados...</td></tr>
    </tbody>
  </table>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <!-- FileSaver para salvar docx -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- docx -->
  <script src="https://cdn.jsdelivr.net/npm/docx@7.0.0/build/index.umd.js"></script>

  <script>
    // Inicialização Firebase (substitua com seu config)
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_AUTH_DOMAIN",
      databaseURL: "SUA_DATABASE_URL",
      projectId: "SEU_PROJECT_ID",
      storageBucket: "SEU_STORAGE_BUCKET",
      messagingSenderId: "SEU_SENDER_ID",
      appId: "SEU_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const armariosRef = database.ref('armarios');

    const form = document.getElementById('form');
    const nomeInput = document.getElementById('nome');
    const empresaInput = document.getElementById('empresa');
    const setorInput = document.getElementById('setor');
    const numeroInput = document.getElementById('numero');
    const tabelaBody = document.getElementById('tabela-body');
    const pesquisaInput = document.getElementById('pesquisa');
    const btnExportarDocx = document.getElementById('btnExportarDocx');

    let editKey = null;
    let dadosAtuais = [];

    function renderTabela(dados) {
      if (dados.length === 0) {
        tabelaBody.innerHTML = '<tr><td colspan="5">Nenhum dado encontrado.</td></tr>';
        return;
      }
      tabelaBody.innerHTML = '';
      dados.forEach(({ key, val }) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${val.nome || ''}</td>
          <td>${val.empresa || ''}</td>
          <td>${val.setor || ''}</td>
          <td>${val.numero || ''}</td>
          <td><button class="btn-editar" data-key="${key}">Editar</button></td>
        `;
        tabelaBody.appendChild(tr);
      });

      // Adicionar evento para os botões de editar
      document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.onclick = () => {
          const key = btn.getAttribute('data-key');
          const item = dadosAtuais.find(d => d.key === key);
          if (item) {
            nomeInput.value = item.val.nome || '';
            empresaInput.value = item.val.empresa || '';
            setorInput.value = item.val.setor || '';
            numeroInput.value = item.val.numero || '';
            editKey = key;
            form.querySelector('button').textContent = 'Atualizar';
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        };
      });
    }

    function atualizarTabelaFiltrada(dados) {
      const termo = pesquisaInput.value.toLowerCase();
      const filtrados = dados.filter(({ val }) =>
        (val.nome && val.nome.toLowerCase().includes(termo)) ||
        (val.empresa && val.empresa.toLowerCase().includes(termo)) ||
        (val.setor && val.setor.toLowerCase().includes(termo)) ||
        (val.numero && val.numero.toString().includes(termo))
      );
      renderTabela(filtrados);
    }

    onValue(armariosRef, (snapshot) => {
      const dados = snapshot.val();
      if (!dados) {
        tabelaBody.innerHTML = '<tr><td colspan="5">Sem dados cadastrados.</td></tr>';
        dadosAtuais = [];
        return;
      }
      dadosAtuais = Object.entries(dados).map(([key, val]) => ({ key, val }));
      atualizarTabelaFiltrada(dadosAtuais);
    });

    pesquisaInput.addEventListener('input', () => {
      atualizarTabelaFiltrada(dadosAtuais);
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const nome = nomeInput.value.trim();
      const empresa = empresaInput.value.trim();
      const setor = setorInput.value.trim();
      const numero = numeroInput.value.trim();

      if (!nome || !numero) {
        alert('Por favor, preencha nome e número.');
        return;
      }

      const dadosParaSalvar = { nome, empresa, setor, numero };

      if (editKey) {
        armariosRef.child(editKey).set(dadosParaSalvar)
          .then(() => {
            alert('Dados atualizados com sucesso.');
            form.reset();
            pesquisaInput.value = '';
            editKey = null;
            form.querySelector('button').textContent = 'Adicionar / Atualizar';
          })
          .catch((error) => alert('Erro ao atualizar: ' + error));
      } else {
        armariosRef.push(dadosParaSalvar)
          .then(() => {
            alert('Dados adicionados com sucesso.');
            form.reset();
            pesquisaInput.value = '';
          })
          .catch((error) => alert('Erro ao adicionar: ' + error));
      }
    });

    // Exportar para Word (usando docx.js)
    btnExportarDocx.onclick = () => {
      const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, TextRun } = docx;

      if (dadosAtuais.length === 0) {
        alert('Não há dados para exportar.');
        return;
      }

      const rows = [];

      // Cabeçalho
      rows.push(new TableRow({
        children: [
          new TableCell({ children: [new Paragraph('Nome')] }),
          new TableCell({ children: [new Paragraph('Empresa')] }),
          new TableCell({ children: [new Paragraph('Setor')] }),
          new TableCell({ children: [new Paragraph('Número')] }),
        ]
      }));

      // Dados
      dadosAtuais.forEach(({ val }) => {
        rows.push(new TableRow({
          children: [
            new TableCell({ children: [new Paragraph(val.nome || '')] }),
            new TableCell({ children: [new Paragraph(val.empresa || '')] }),
            new TableCell({ children: [new Paragraph(val.setor || '')] }),
            new TableCell({ children: [new Paragraph(val.numero ? val.numero.toString() : '')] }),
          ]
        }));
      });

      const table = new Table({
        width: {
          size: 100,
          type: WidthType.PERCENTAGE,
        },
        rows: rows,
      });

      const doc = new Document({
        sections: [{
          properties: {},
          children: [table],
        }],
      });

      Packer.toBlob(doc).then(blob => {
        saveAs(blob, "dados_armarios.docx");
      });
    };
  </script>
</body>
</html>
