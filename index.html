<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Arm√°rios</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 0;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    header {
      width: 100%;
      background-color: #1f3b68;
      color: white;
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    main {
      width: 100%;
      max-width: 1100px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.05);
      padding: 40px;
      margin: 40px 20px;
    }

    h1 {
      margin: 0;
      font-size: 28px;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }

    input[type="text"],
    input[type="number"] {
      flex: 1;
      padding: 12px 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      min-width: 200px;
    }

    button[type="submit"] {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      transition: background 0.3s;
    }

    button[type="submit"]:hover {
      background-color: #0056b3;
    }

    .barra-pesquisa {
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #pesquisa {
      width: 100%;
      max-width: 700px;
      padding: 14px 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 10px;
    }

    /* ALTERA√á√ÉO: qrCode agora √© canvas, mas o estilo pode continuar */
    #qrCode {
      margin-bottom: 10px;
      /* opcional: defina tamanho fixo para o canvas */
      width: 180px;
      height: 180px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 16px 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #1f3b68;
      color: white;
      font-weight: 600;
      font-size: 16px;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    .btn-edit, .btn-delete {
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 6px;
      cursor: pointer;
    }

    .btn-edit {
      background-color: #ffc107;
      color: #212529;
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
    }

    @media (max-width: 768px) {
      main {
        padding: 20px;
      }

      form {
        flex-direction: column;
      }

      #pesquisa {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Controle de Arm√°rios</h1>
</header>

<main>
  <form id="formArmario">
    <input type="text" id="nome" placeholder="Nome do Colaborador" required />
    <input type="text" id="empresa" placeholder="Empresa" required />
    <input type="number" id="numero" placeholder="N√∫mero do Arm√°rio" required min="1" />
    <button type="submit">Adicionar / Atualizar</button>
  </form>

  <div class="barra-pesquisa">
    <!-- Altera√ß√£o: de div para canvas -->
    <canvas id="qrCode"></canvas>
    <p>Escaneie o QR Code para abrir o formul√°rio.</p>
  </div>

  <input type="text" id="pesquisa" placeholder="üîç Pesquisar por nome, empresa ou n√∫mero..." />

  <table id="tabelaArmarios">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Empresa</th>
        <th>N√∫mero do Arm√°rio</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const qrCodeElement = document.getElementById('qrCode');
    const urlFormulario = window.location.origin + '/formulario.html'; // ajuste se necess√°rio
    QRCode.toCanvas(qrCodeElement, urlFormulario, function (error) {
      if (error) {
        console.error('Erro ao gerar QR Code:', error);
      } else {
        console.log('QR Code gerado!');
      }
    });
  });
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, remove, update } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCfBDyXi9sYCgb0Z_1ApmPk2PcwL5nhXI4",
    authDomain: "armarios-b3c30.firebaseapp.com",
    projectId: "armarios-b3c30",
    storageBucket: "armarios-b3c30.appspot.com",
    messagingSenderId: "1036955127916",
    appId: "1:1036955127916:web:de798f7e226a9f58e60849"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const armariosRef = ref(db, 'armarios');

  const form = document.getElementById('formArmario');
  const nomeInput = document.getElementById('nome');
  const empresaInput = document.getElementById('empresa');
  const numeroInput = document.getElementById('numero');
  const tabelaBody = document.querySelector('#tabelaArmarios tbody');
  const pesquisaInput = document.getElementById('pesquisa');

  let editKey = null;

  function renderTabela(data) {
    tabelaBody.innerHTML = '';
    data.forEach(({ key, val }) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${val.nome}</td>
        <td>${val.empresa || ''}</td>
        <td>${val.numero}</td>
        <td>
          <button class="btn-edit" data-key="${key}">‚úèÔ∏è</button>
          <button class="btn-delete" data-key="${key}">üóëÔ∏è</button>
        </td>
      `;
      tabelaBody.appendChild(tr);
    });
  }

  function atualizarTabelaFiltrada(dados) {
    const termo = pesquisaInput.value.toLowerCase();
    const filtrados = dados.filter(({ val }) =>
      val.nome.toLowerCase().includes(termo) ||
      (val.empresa && val.empresa.toLowerCase().includes(termo)) ||
      val.numero.toString().includes(termo)
    );
    renderTabela(filtrados);
  }

  onValue(armariosRef, (snapshot) => {
    const dados = snapshot.val();
    if (!dados) {
      tabelaBody.innerHTML = '<tr><td colspan="4">Sem dados cadastrados.</td></tr>';
      return;
    }
    const arr = Object.entries(dados).map(([key, val]) => ({ key, val }));
    atualizarTabelaFiltrada(arr);
    pesquisaInput.oninput = () => atualizarTabelaFiltrada(arr);
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const nome = nomeInput.value.trim();
    const empresa = empresaInput.value.trim();
    const numero = numeroInput.value.trim();

    if (!nome || !empresa || !numero) {
      alert('Preencha todos os campos!');
      return;
    }

    try {
      if (editKey) {
        await update(ref(db, 'armarios/' + editKey), { nome, empresa, numero });
        editKey = null;
        form.querySelector('button').textContent = 'Adicionar / Atualizar';
      } else {
        const snapshot = await new Promise(resolve => {
          onValue(armariosRef, snap => resolve(snap), { onlyOnce: true });
        });
        const dados = snapshot.val() || {};
        const existeNumero = Object.values(dados).some(item => item.numero === numero);
        if (existeNumero) {
          alert('N√∫mero do arm√°rio j√° est√° atribu√≠do!');
          return;
        }
        await push(armariosRef, { nome, empresa, numero });
      }

      form.reset();
    } catch (err) {
      console.error('Erro ao salvar:', err);
      alert('Erro ao salvar dados. Veja console.');
    }
  });

  tabelaBody.addEventListener('click', async (e) => {
    if (e.target.classList.contains('btn-edit')) {
      const key = e.target.dataset.key;
      const snapshot = await new Promise(resolve => {
        onValue(ref(db, 'armarios/' + key), snap => resolve(snap), { onlyOnce: true });
      });
      const data = snapshot.val();
      if (data) {
        nomeInput.value = data.nome;
        empresaInput.value = data.empresa || '';
        numeroInput.value = data.numero;
        editKey = key;
        form.querySelector('button').textContent = 'Salvar Altera√ß√µes';
      }
    }

    if (e.target.classList.contains('btn-delete')) {
      const key = e.target.dataset.key;
      if (confirm('Quer mesmo excluir esse arm√°rio?')) {
        try {
          await remove(ref(db, 'armarios/' + key));
        } catch (err) {
          console.error('Erro ao deletar:', err);
          alert('Erro ao deletar dados. Veja console.');
        }
      }
    }
  });
</script>

</body>
</html>
